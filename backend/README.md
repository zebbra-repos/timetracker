# Timetracker Backend

<div align="center">
  <strong>
    Timetracker software for the<a href="https://www.medi.ch/">medi</a>company
  </strong>
</div>
<div align="center">The project is generated by <a href="http://loopback.io">LoopBack</a>.</div>

<br />

<div align="center">
  <!-- Dependency Status -->
  <a href="https://david-dm.org/zebbra-repos/Zeiterfassung-medi-server">
    <img src="https://david-dm.org/zebbra-repos/Zeiterfassung-medi-server.svg"
    alt="Dependency Status" />
  </a>
  <!-- devDependency Status -->
  <a href="https://david-dm.org/zebbra-repos/Zeiterfassung-medi-server?type=dev">
    <img src="https://david-dm.org/zebbra-repos/Zeiterfassung-medi-server/dev-status.svg"
    alt="devDependency Status" />
  </a>
  <!-- Build Status -->
  <a href="https://travis-ci.org/zebbra-repos/Zeiterfassung-medi-server">
    <img src="https://travis-ci.org/zebbra-repos/Zeiterfassung-medi-server.svg"
    alt="Build Status" />
  </a>
</div>

<br />

<div align="center">
  <sub>
    Created by <a href="http://zebbra.ch">zebbra AG</a> and maintained with ❤️
    by an amazing
    <a href="https://github.com/orgs/zebbra/people">team of developers</a>.
  </sub>
</div>

## Tech-Stack

- [Node.js](https://nodejs.org/en/) v10.x
- [Yarn](https://yarnpkg.com/lang/en/) v1.x
- [mongoDB](https://www.mongodb.com/) v3.x

## Development

### Setup

```bash
git@github.com:zebbra-repos/Zeiterfassung-medi-server.git
yarn install
yarn run db:seed
```

### Workflow

The development process uses the follwing workflow:

1. Find an issue on Github and assign it to yourself.
2. Create a new branch with the issue number as prefix:

   ```bash
   git checkout -b 16_new_feature
   ```

3. Implement the feature and commit each step of your implementation:

   ```bash
   git push -u origin 16_new_feature
   ```

4. Use `hub` to change the issue into a pull-request.

   ```bash
   hub pull-request -i 16
   ```

   **Note**: _Make sure you already pushed the branch to Github and have the
   branch checked out. `brew install hub` if you don't have this already._

5. Once the feature is ready for review, mention an peer on the pull request
   and let the peer know to do the review.
6. After the review is over, the reviewer merges the branch.
7. Rinse and repeat

### Testing

```bash
yarn test
```

## Production

TODO

## Cronjobs

In production the cron jobs are started automatically. For development use:

```bash
yarn run cron:start
```

## Environment Variables

### Database

- `MONGO_URL` the mongodb instance to connect to (e.g. `mongodb://localhost:27017/timetracker?auto_reconnect=true`)

### Sendgrid

- `SENDGRID_PASS` the smtp auth password (default to `undefined` e.g. no auth)

### Sentry

- `SENTRY_DSN` private sentry dsn key for express server

### Logging

- `DEBUG` what message to log (e.g. `*,-loopback:connector:mongodb*`)

### New Relic

- `NEW_RELIC_KEY` the new relic access key

## Automatic backups with dokku and amazon s3

```bash
# List all dokku mongo commands
$ dokku mongo:help
# Setup aws s3 bucket auth
$ dokku mongo:backup-auth DATABASE AWS_ACCESS_KEY_ID AWS_SECRET_ACCESS_KEY
AWS_REGION AWS_SIGNATURE_VERSION ENDPOINT_URL
# Backup
$ dokku mongo:backup DATABASE MY_S3_BUCKET
# Schedule
$ dokku mongo:backup-schedule DATABASE "0 3 * * *" MY_S3_BUCKET
```
